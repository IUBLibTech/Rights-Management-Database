<h3 class="">
  <%= link_to(@atom_feed_read.avalon_item_url, {target: "_blank", id: "foo"}) do %>
    <span class="avalon_item_title rvt-text-bold">
      <%= @avalon_item.title %>
      <i class="fa fa-external-link xxsmall"><span class=sr-only>opens a new window</span></i>
      <span class="">
        <%= @avalon_item.rivet_button_badge %>
      </span>
    </span>
  <% end %>
</h3>
<div class="avalon_item_metadata">
  <div id="access_div" class="display-flex">
    <div class=rvt-grid__item-lg>
      <label for=access>Access Determination:</label>
      <%= select_tag :access, options_for_select(@avalon_item.allowed_access_determinations.collect{|a| [a,a]}, @avalon_item.access_determination) %>
    </div>
    <div class="rvt-grid__item-lg rightButton">
      <div>
        <button type=button class=rvt-button data-modal-trigger=modal-note>Avalon Item Note</button>
        <div class=rvt-modal id=modal-note role=dialog aria-labelledby=modal-example-title aria-hidden=true tabindex=-1>
          <div class=rvt-modal__inner>
            <header class=rvt-modal__header>
              <h1 class=rvt-modal__title id=modal-example-title>Avalon Item Notes</h1></header>
            <div class=rvt-modal__body>
              <div class=rvt-grid__item-12>
                <label for=notes1>Avalon Item Notes</label>
                <textarea class=swal2-textarea id=notes1 aria-labelledby=notes></textarea>
              </div>
            </div>
            <div class=rvt-modal__controls>
              <button type=button class=rvt-button>OK</button>
              <button type=button class="rvt-button rvt-button--secondary" data-modal-close=modal-note>Cancel</button>
            </div>
          </div>
        </div>

        <% #communication between CL and CM %>
        <%
          cl = User.current_user_copyright_librarian?
          msg = nil
          case @avalon_item.review_state
          when AvalonItem::REVIEW_STATE_DEFAULT
            msg = "Request Review"
          when AvalonItem::REVIEW_STATE_REVIEW_REQUESTED
            msg = cl ? "Respond to Collection Manager" : "Add Additional Comments"
          when AvalonItem::REVIEW_STATE_WAITING_ON_CM
            msg = cl ? "Add Additional Comments" : "Respond to Copyright Librarian"
          when AvalonItem::REVIEW_STATE_WAITING_ON_CL
            msg = cl ? "Respond to Copyright Librarian" : "Add Additional Comments"
          when AvalonItem::REVIEW_STATE_ACCESS_DETERMINED
            msg = "Access Determined"
          else
            raise "How did we get to this ReviewState???"
          end
        %>
        <button id=flagCopyrightLibrarian class=rvt-button data-modal-trigger=modal-example-basic><%= msg %></button>



        <div class="rvt-dropdown">
          <button type="button" class="rvt-button" data-dropdown-toggle="dropdown-navigation" aria-haspopup="true" aria-expanded="false" >
            <span>History</span>
            <svg aria-hidden="true" class="rvt-m-left-xs" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16">
              <path fill="currentColor" d="M8,12.46a2,2,0,0,1-1.52-.7L1.24,5.65a1,1,0,1,1,1.52-1.3L8,10.46l5.24-6.11a1,1,0,0,1,1.52,1.3L9.52,11.76A2,2,0,0,1,8,12.46Z"/>
            </svg>
          </button>
          <div class="rvt-dropdown__menu rvt-dropdown__menu--right rvt-m-top-xl" id="dropdown-navigation" aria-hidden="true" role="menu" >
            <% @avalon_item.past_access_decisions.order("id DESC").each do |d| %>
            <div class="past_access_dec_div noselect <%= d.copyright_librarian? ? 'cl_dec' : '' %>">
              <%= d.decision %> (<%= d.changed_by %>: <%= d.created_at.strftime("%l:%M%p %Y/%m/%d") %> )
            </div>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div id="recordings_div" class="rvt-p-all-sm bgGray">
    <h2>Recordings In This Avalon Item </h2>
    <% @avalon_item.recordings.each do |recording| %>
      <%= render partial: 'recordings/ajax_show', locals: {recording: recording} %>
    <% end %>
  </div>
</div>
<div class="">
  <h3 class="accordion accordion-title active">Avalon Metadata</h3>
  <div class="rvt-grid m-fadeIn">
    <table class="json_table">
      <tbody>
      <tr>
        <th>Title</th>
        <td class="adder"><%= @json["title"] %></td>
      </tr>
      <tr>
        <th>Unit</th>
        <td>
          <%= @avalon_item.pod_unit %>
        </td>
        <th>Creator</th>
        <td>
          <ul>
            <% @json["fields"]["creator"]&.each do |mc| %>
              <li class="adder people"><%= mc %></li>
            <% end %>
          </ul>
        </td>
      </tr>
      <tr>
        <th>Uniform Title</th>
        <td class="adder work"><%= @json["uniform_title"] %></td>
        <th>Date Created</th>
        <td><%= @json["fields"]["date_created"] %></td>
      </tr>
      <tr>
        <th>Translated Title</th>
        <td class="adder work">
          <%= @json["translated_title"] %>
        </td>
        <th>Date Issued</th>
        <td class="adder date issue"><%= @json["fields"]["date_issued"] %></td>
      </tr>
      <tr>
        <th>Avalon Collection</th>
        <td><%= @json["collection"] %></td>
        <th>Copyright Date</th>
        <td class="adder date copyright"><%= @json["fields"]["copyright_date"] %></td>
      </tr>
      <tr>
        <th>Main Contributors</th>
        <td>
          <ul>
            <% @json["main_contributors"]&.each do |mc| %>
              <li class="adder people"><%= mc %></li>
            <% end %>
          </ul>
        </td>
        <th>Publisher</th>
        <td>
          <ul>
            <% @json["fields"]["publisher"]&.each do |mc| %>
              <li><%= mc %></li>
            <% end %>
          </ul>
        </td>
      </tr>
      <tr>
        <th>Publication Date</th>
        <td class="adder date publication">
          <%= @json["publication_date"] %>
        </td>
        <th>Physical Description</th>
        <td>
          <ul>
            <% @json["fields"]["physical_description"]&.each do |mc| %>
              <li><%= mc %></li>
            <% end %>
          </ul>
        </td>
      </tr>
      <tr>
        <th>Bibliographic ID</th>
        <td><%= @json["fields"]["bibliographic_id"] %></td>
        <th>Statement of Responsibility</th>
        <td><%= @json["fields"]["statement_of_responsibility"] %></td>
      </tr>
      <tr>
        <th>Note</th>
        <td><%= @json["fields"]["note"] %></td>
        <th>Contributor</th>
        <td>
          <ul>
            <% @json["fields"]["contributor"]&.each do |mc| %>
              <li><%= mc %></li>
            <% end %>
          </ul>
        </td>
      </tr>
      <tr>
        <th>Language</th>
        <td>
          <ul>
            <% @json["fields"]["language"]&.each do |mc| %>
              <li><%= mc %></li>
            <% end %>
          </ul>
        </td>
        <th>Terms of Use</th>
        <td><%= @json["fields"]["terms_of_use"] %></td>
      </tr>
      <tr>
        <th>Table of Contents</th>
        <td>
          <ul>
            <% @json["fields"]["table_of_contents"]&.each do |mc| %>
              <li class='adder work'><%= mc %></li>
            <% end %>
          </ul>
        </td>
      </tr>
      </tbody>
    </table>
  </div>
</div>
<div>
  <h3 class="accordion accordion-title active">JSON</h3>
  <div class="rvt-grid m-fadeIn">
    <pre>
      <%= JSON.pretty_generate @json %>
    </pre>
  </div>
</div>
<script type="text/javascript" charset="utf-8">
    $(document).ready(function() {
        hookAccordion();
        hookButtons();
        $("#access").change(function() {
            let val = $(this).find("option:selected").attr('value');
            ajaxAccess(val);
        })
    });

    function ajaxAccess(decision) {
        $.ajax({
            url: '<%= ajax_avalon_item_access_decision_path %>',
            method: "POST",
            data: {
                id: <%= @avalon_item.id %>,
                access: decision
            },
            success: function(response) {
                swal.fire({
                    title: 'Updated Record',
                    html: "This Avalon Item was successfully updated"
                }).then(function() {
                    loadRmdMetadata();
                })
            },
            error: function(jqXHR, textStatus, errorThrown) {
                swal.fire({
                    title: "Error",
                    heightAuto: false,
                    type: 'error',
                    html: "An error occurred while trying to update the access determination:<br/><pre>"+ jqXHR.responseText +"</pre>"
                })
            }
        })
    }
</script>
